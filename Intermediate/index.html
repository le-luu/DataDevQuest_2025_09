<!DOCTYPE html>
<html lang="en" data-bs-theme="dark" class="html-height">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="styles.css" />

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB"
      crossorigin="anonymous"
    />

    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css"
    />
    <title>DataDevQuest - DDQ2025-09 - Embedding: Intermediate</title>
  </head>

  <body class="body-height">
    <!-- Navbar -->
    <nav class="navbar bg-body-secondary">
      <div class="container-fluid">
        <a class="navbar-brand"
          ><i class="bi bi-globe-americas-fill pe-3"></i>DataDevQuest -
          DDQ2025-09: Intermediate
        </a>

        <div id="loadingSpinner">
          <div
            class="spinner-border spinner-border-sm loading-text"
            role="status"
          >
            <span class="visually-hidden">Loading...</span>
          </div>
          <span class="ms-2 loading-text">Tableau content is loading...</span>
        </div>

        <!-- Add Success Message -->
        <!-- At the beginning add the loading-hidden to hide the success message -->
        <div id="successMessage" class="text-ready text-center loading-hidden">
          <i class="bi bi-check-circle-fill me-2"></i>
          Tableau content is ready!
        </div>

        <div class="d-flex align-items-center me-4">
          <span class="double-em">
            <i class="bi bi-person-fill me-2"></i>
          </span>
          <span> Le </span>
        </div>
      </div>
    </nav>

    <!-- Offcanvas (slide-in) for details pane -->
    <div
      class="offcanvas offcanvas-end"
      tabindex="-1"
      id="offcanvas"
      aria-labelledby="offcanvasLabel"
    >
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="offcanvasLabel">
          Hey! You selected some data!
        </h5>
        <button
          type="button"
          class="btn-close"
          onclick="hideDetailsPane()"
          aria-label="Close"
        ></button>
      </div>
      <div class="offcanvas-body">
        <div class="w-100">
          <div class="alert alert-info" role="alert">
            <!-- SHow how many marks selected inside the alert box-->
            <p id="selectionMessage" class="fw-bold text-info mb-2"></p>
          </div>
        </div>
        <div class="d-flex justify-content-end me-3 mb-4 w-100">
          <button
            type="button"
            class="w-100 btn btn-sm btn-outline-danger"
            onclick="clearSelectedMarks(selectedWorksheet)"
          >
            CLEAR ALL SELECTIONS
          </button>
        </div>
        <div id="stateList" class="list-group"></div>
      </div>
    </div>

    <!-- Tableau Viz Container -->
    <div class="container-fluid d-flex h-100 main-container-width">
      <!-- Tableau Viz Goes Here -->
      <tableau-viz
        id="tableauViz"
        src="https://public.tableau.com/views/Superstore_embedded_800x800/Overview"
        toolbar="bottom"
        hide-tabs
      >
      </tableau-viz>
    </div>

    <!--  Bootstrap Bundle with Popper -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
      crossorigin="anonymous"
    ></script>

    <!-- Tableau Embedding API -->

    <script type="module">
      import {
        TableauEventType,
        SelectionUpdateType,
      } from "https://public.tableau.com/javascripts/api/tableau.embedding.3.latest.js";

      // Make SelectionUpdateType available globally to use in funcs.js for update the state list
      window.SelectionUpdateType = SelectionUpdateType;

      // Global variables
      const viz = document.querySelector("tableau-viz");
      const loadingSpinner = document.getElementById("loadingSpinner");
      const successMessage = document.getElementById("successMessage");
      const selectionMessage = document.getElementById("selectionMessage");

      //set opacity to 0 initially
      viz.style.opacity = "0";

      //Define function to handle first interactive event
      function onFirstInteractive() {
        // Log to console
        console.log("Tableau Dashboard is Loaded!");

        //Add loading-spinner to hide the spinner
        loadingSpinner.classList.add("loading-hidden");
        //remove loading-hidden from success message class and set opacity to 1 to show on the screen
        successMessage.classList.remove("loading-hidden");
        viz.style.opacity = "1";

        // Set timeout 2 seconds to hide the success message
        setTimeout(() => {
          successMessage.classList.add("loading-hidden");
        }, 2000);

        // Get the dashboard and the specific worksheet
        const dashboard = viz.workbook.activateSheetAsync("Overview");
        dashboard.then((db) => {
          const worksheet = db.worksheets.find((ws) => ws.name === "SaleMap");
          // Store the selected worksheet in a global variable to use in other functions
          window.selectedWorksheet = worksheet;

          // Add event listener for mark selection change with function onSelectionChanged
          viz.addEventListener(
            TableauEventType.MarkSelectionChanged,
            onSelectionChanged
          );
        });
      }

      // Add event listener for first interactive event
      viz.addEventListener("firstinteractive", onFirstInteractive);

      // Define async function to handle selection change event
      async function onSelectionChanged(event) {
        //Apply getMarksAsync to get the selected marks
        //Source: https://help.tableau.com/current/api/embedding_api/en-us/docs/embedding_api_select_marks.html
        const marks = await event.detail.getMarksAsync();

        // Check if any marks are selected. If no marks selected, hide the details pane
        if (!marks.data || marks.data.length === 0) {
          console.log("No marks selected.");
          hideDetailsPane();
          return;
        }

        // If marks are selected, get the columns and data of the first set of marks
        selectedMarksColumns = marks.data[0].columns;
        selectedMarksData = marks.data[0].data;
        //formatData function is in funcs.js to add each selected mark to the state array
        formatData();

        //Count total selected marks and store it in totalMarks variable
        const totalMarks = selectedMarksData.length;

        //Show the totalMarks inside the alert box in the details pane above
        const selectionMessage = document.getElementById("selectionMessage");
        // Use plural "marks" if more than 1 mark is selected
        if (selectionMessage) {
          selectionMessage.textContent = `You Selected ${totalMarks} mark${
            totalMarks > 1 ? "s" : ""
          }`;
        }

        //Call the buildStateDOMList function in funcs.js to build the state list in the details pane with the format in Profit Ratio
        buildStateDOMList(window.selectedWorksheet);
        //Show or hide the details pane based on the number of selected marks
        showHideDetailsPane();
      }
    </script>

    <!-- Custom JavaScript -->
    <script src="funcs.js"></script>
  </body>
</html>
